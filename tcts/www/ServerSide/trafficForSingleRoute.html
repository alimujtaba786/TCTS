<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Draggable directions</title>
<style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
      #panel {
        position: absolute;
        top: 5px;
        left: 50%;
        margin-left: -180px;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
      <script src="js/jquery-1.9.1.js" type="text/javascript"></script>
    <script>
        var map;
        var directionsDisplay;
        var directionsService;
        var stepDisplay;
        var markerArray = [];
        function getData(time) {
            if ($('#start').val() != "point" || $('#end').val() != "point") return;
            $.ajax({
                type: "POST",
                url: "http://207.45.190.206/~lolism/mujtaba/FetchTraffic.php",
                data: { time: time}
            }).success(function (result) { displayMarkers(result); });
        }
        function removeMarkers() {
            for (var i = 0; i < markerArray.length; i++) {
                markerArray[i].setMap(null);
            }

            // Now, clear the array itself.
            markerArray = [];
        }
        function displayMarkers(json) {
            removeMarkers();
            obj = JSON.parse(json);
            
            var i = 0;
            for (var property in obj) {
                if (obj.hasOwnProperty(property)) {
                    var a = obj[property];
                    //alert(a.id);
                    var image = 'images/'+getColorBySpeed(a.speed)+'.png';
                    var marker = new google.maps.Marker({
                        position: new google.maps.LatLng(a.lat, a.lng),
                        map: map,
                        icon:image
                    });
                    attachInstructionText(marker, 'Vehicle No. : ' + a.id + ' Speed : ' + a.speed + ' Lat : ' + a.lat + ' Lng : ' + a.lng);
                    markerArray[i] = marker;
                    i++;
                }
            }
        }
        function getColorBySpeed(speed) {
            if (speed <= 10) {
                return "red";
            } else if(speed<=20){
                return "blue";
            } else if (speed <= 40) {
                return "yellow";
            } else {
                return "green";
            }
        }
        function initialize() {
            // Instantiate a directions service.
            directionsService = new google.maps.DirectionsService();

            // Create a map and center it on Manhattan.
            var karachi = new google.maps.LatLng(24.9201551, 67.094978999999970000);
            var mapOptions = {
                zoom: 18,
                center: karachi
            }
            map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

            // Create a renderer for directions and bind it to the map.
            //var rendererOptions = {
            //    map: map
            //}
            directionsDisplay = [];//new google.maps.DirectionsRenderer(rendererOptions)

            // Instantiate an info window to hold step text.
            stepDisplay = new google.maps.InfoWindow();
            calcRoute();
            
        }

        function calcRoute() {

            // First, remove any existing markers from the map.
            //for (var i = 0; i < markerArray.length; i++) {
            //    markerArray[i].setMap(null);
            //}

            //// Now, clear the array itself.
            //markerArray = [];
            removeMarkers();
            // Retrieve the start and end locations and create
            // a DirectionsRequest using WALKING directions.
            var start = document.getElementById('start').value;
            var end = document.getElementById('end').value;
            var request = {
                origin: start=="point"?new google.maps.LatLng(24.9557, 67.0779):start,
                destination: end=="point"?new google.maps.LatLng(24.8922, 67.1218):end,
                travelMode: google.maps.TravelMode.DRIVING,
                provideRouteAlternatives: true
            };
            for (var i = 0; i < directionsDisplay.length; i++) { directionsDisplay[i].setMap(null); };
            //directionsDisplay = [];
            // Route the directions and pass the response to a
            // function to create markers for each step.
            directionsService.route(request, function (response, status) {
                if (status == google.maps.DirectionsStatus.OK) {
                    var warnings = document.getElementById('warnings_panel');
                    warnings.innerHTML = '<b>' + response.routes[0].warnings + '</b>';
                    //directionsDisplay.setDirections(response);
                    for (var i = 0, len = response.routes.length; i < len; i++) {
                        directionsDisplay[i] = new google.maps.DirectionsRenderer({
                            map: map,
                            directions: response,
                            routeIndex: i,
                            draggable: true
                        });
                    }
                    
                }
            });
            if(start=="point" && end=="point") getData($('#time').val());
        }

        function getSteps(directionResult) {
        //    // For each step, place a marker, and add the text to the marker's
        //    // info window. Also attach the marker to an array so we
        //    // can keep track of it and remove it when calculating new
            //    // routes.
            var points = [];
            var point = [];
            var myRoute = directionResult.routes[0].legs[0];
            //for (var i = 0; i < myRoute.steps.length; i++) {
            //    var marker = new google.maps.Marker({
            //        position: myRoute.steps[i].start_location,
            //        map: map,
            //        icon: mimage,
            //        shape:'poly'
            //    });
            //    attachInstructionText(marker, myRoute.steps[i].instructions);
            //    markerArray[i] = marker;
            //}
            //for (var i = 0; i < myRoute.steps.length; i++) {
                
            //    point[0] = myRoute.steps[i].start_location.lat;
            //    point[1] = myRoute.steps[i].start_location.lon;
            //    points[i] = point;
            //}
            //return points;
        }

        function attachInstructionText(marker, text) {
            google.maps.event.addListener(marker, 'click', function () {
                // Open an info window when the marker is clicked on,
                // containing the text of the step.
                stepDisplay.setContent(text);
                stepDisplay.open(map, marker);
            });
        }

        google.maps.event.addDomListener(window, 'load', initialize);
    </script>
  </head>
  <body>
    <div id="panel">
    <b>Start: </b>
    <select id="start" onchange="calcRoute();">
      <option value="point">Rashid Minhas Road</option>
      <option value="IBA, Pedestrian Bridge IBA City Campus, Karachi, Sindh, Pakistan">IBA City Campus</option>
      <option value="IBA Main Campus, KU Circular Road, Karachi, Sindh, Pakistan">IBA Main Campus</option>
      <option value="Karachi Airport, Karachi, Sindh, Pakistan">Karachi Airport</option>
      <option value="Saddar, Karachi, Sindh, Pakistan">Saddar</option>
    </select>
    <b>End: </b>
    <select id="end" onchange="calcRoute();">
      <option value="point">Rashid Minhas Road</option>
      <option value="IBA, Pedestrian Bridge IBA City Campus, Karachi, Sindh, Pakistan">IBA City Campus</option>
      <option value="IBA Main Campus, KU Circular Road, Karachi, Sindh, Pakistan">IBA Main Campus</option>
      <option value="Karachi Airport, Karachi, Sindh, Pakistan">Karachi Airport</option>
      <option value="Numaish, Karachi, Sindh, Pakistan">Numaish</option>
    </select>
        <input type="time" id="time" value="16:00" onchange="getData(this.value);"/><br />
        <b>Speed Chart (km/h): </b><span><img src="images/red.png" /> 0 - 10 </span>&nbsp&nbsp
        <span><img src="images/blue.png" /> 10 - 20 </span>&nbsp&nbsp
        <span><img src="images/yellow.png" /> 20 - 40 </span>&nbsp&nbsp
        <span><img src="images/green.png" /> Greater Than 40 </span>&nbsp&nbsp
    </div>
    <div id="map-canvas"></div>
    &nbsp;
    <div id="warnings_panel" style="width:100%;height:10%;text-align:center"></div>  </body>
</html>